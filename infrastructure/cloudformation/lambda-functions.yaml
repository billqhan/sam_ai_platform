AWSTemplateFormatVersion: '2010-09-09'
Description: 'AI-powered RFP Response Agent - Lambda Functions Template'

Parameters:
  Environment:
    Type: String
    Default: 'dev'
    Description: 'Environment name for resource naming'
  
  SamApiKey:
    Type: String
    NoEcho: true
    Description: 'API key for SAM.gov access'
  
  CompanyName:
    Type: String
    Default: 'Your Company Name'
    Description: 'Company name for report templates'
  
  CompanyContact:
    Type: String
    Default: 'contact@yourcompany.com'
    Description: 'Company contact information'
  
  SqsSamJsonMessagesQueueArn:
    Type: String
    Description: 'ARN of the SQS queue for JSON messages'
  
  BucketPrefix:
    Type: String
    Default: ''
    Description: 'Optional prefix for S3 bucket names to avoid conflicts'
  
  KnowledgeBaseId:
    Type: String
    Description: 'ID of the Bedrock Knowledge Base for company information'

Conditions:
  HasBucketPrefix: !Not [!Equals [!Ref BucketPrefix, '']]

Resources:
  # Lambda Execution Roles
  SamGovDailyDownloadRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-data-in-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-data-in-${Environment}/*'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-download-files-logs-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-download-files-logs-${Environment}/*'
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'

  SamJsonProcessorRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: 
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-data-in-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-data-in-${Environment}'
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !If 
                  - HasBucketPrefix
                  - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-data-in-${Environment}/*'
                  - !Sub 'arn:aws:s3:::sam-data-in-${Environment}/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !If 
                  - HasBucketPrefix
                  - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-extracted-json-resources-${Environment}/*'
                  - !Sub 'arn:aws:s3:::sam-extracted-json-resources-${Environment}/*'
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'

  SamSqsGenerateMatchReportsRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource: !Ref SqsSamJsonMessagesQueueArn
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: 
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-extracted-json-resources-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-extracted-json-resources-${Environment}'
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !If 
                  - HasBucketPrefix
                  - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-extracted-json-resources-${Environment}/*'
                  - !Sub 'arn:aws:s3:::sam-extracted-json-resources-${Environment}/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-sqs-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-matching-out-sqs-${Environment}/*'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-runs-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-matching-out-runs-${Environment}/*'
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:Retrieve
                Resource: '*'
        - PolicyName: CloudWatchMetrics
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                Resource: '*'

  SamProduceUserReportRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: 
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-sqs-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-matching-out-sqs-${Environment}'
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: !If 
                  - HasBucketPrefix
                  - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-sqs-${Environment}/*'
                  - !Sub 'arn:aws:s3:::sam-matching-out-sqs-${Environment}/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                Resource: !If 
                  - HasBucketPrefix
                  - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-opportunity-responses-${Environment}/*'
                  - !Sub 'arn:aws:s3:::sam-opportunity-responses-${Environment}/*'

  SamMergeAndArchiveResultLogsRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-runs-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-matching-out-runs-${Environment}'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-runs-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-matching-out-runs-${Environment}/*'

  SamProduceWebReportsRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-runs-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-matching-out-runs-${Environment}'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-matching-out-runs-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-matching-out-runs-${Environment}/*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-extracted-json-resources-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-extracted-json-resources-${Environment}'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-extracted-json-resources-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-extracted-json-resources-${Environment}/*'
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-website-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-website-${Environment}'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-website-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-website-${Environment}/*'

  SamDailyEmailNotificationRole:
    Type: AWS::IAM::Role
    Properties:

      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-opportunity-responses-${Environment}'
                    - !Sub 'arn:aws:s3:::sam-opportunity-responses-${Environment}'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-opportunity-responses-${Environment}/*'
                    - !Sub 'arn:aws:s3:::sam-opportunity-responses-${Environment}/*'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-subscribers'
                    - !Sub 'arn:aws:s3:::sam-subscribers'
                  - !If 
                    - HasBucketPrefix
                    - !Sub 'arn:aws:s3:::${BucketPrefix}-sam-subscribers/*'
                    - !Sub 'arn:aws:s3:::sam-subscribers/*'
        - PolicyName: SESAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendRawEmail
                  - ses:GetIdentityVerificationAttributes
                Resource: '*'

  # Lambda Functions
  SamGovDailyDownloadFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-gov-daily-download-${Environment}'
        - !Sub 'sam-gov-daily-download-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamGovDailyDownloadRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 512
      Timeout: 900  # 15 minutes
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          SAM_API_URL: 'https://api.sam.gov/prod/opportunities/v2/search'
          SAM_API_KEY: !Ref SamApiKey
          OUTPUT_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-data-in-${Environment}'
            - !Sub 'sam-data-in-${Environment}'
          LOG_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-download-files-logs-${Environment}'
            - !Sub 'sam-download-files-logs-${Environment}'
          API_LIMIT: '1000'
          OVERRIDE_DATE_FORMAT: 'MM/DD/YYYY'
          OVERRIDE_POSTED_FROM: ''
          OVERRIDE_POSTED_TO: ''
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-gov-daily-download'

  SamJsonProcessorFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-json-processor-${Environment}'
        - !Sub 'sam-json-processor-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamJsonProcessorRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 2048
      Timeout: 600  # 10 minutes
      EphemeralStorage:
        Size: 1024
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          OUTPUT_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-extracted-json-resources-${Environment}'
            - !Sub 'sam-extracted-json-resources-${Environment}'
          SAM_EXTRACTED_JSON_RESOURCES_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-extracted-json-resources-${Environment}'
            - !Sub 'sam-extracted-json-resources-${Environment}'
          MAX_CONCURRENT_DOWNLOADS: '10'
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-json-processor'

  SamSqsGenerateMatchReportsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-sqs-generate-match-reports-${Environment}'
        - !Sub 'sam-sqs-generate-match-reports-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamSqsGenerateMatchReportsRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 2048
      Timeout: 300  # 5 minutes - increased for LLM processing
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          BEDROCK_REGION: 'us-east-1'
          KNOWLEDGE_BASE_ID: !Ref KnowledgeBaseId
          MATCH_THRESHOLD: '0.7'
          OUTPUT_BUCKET_SQS: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-matching-out-sqs-${Environment}'
            - !Sub 'sam-matching-out-sqs-${Environment}'
          OUTPUT_BUCKET_RUNS: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-matching-out-runs-${Environment}'
            - !Sub 'sam-matching-out-runs-${Environment}'
          MAX_ATTACHMENT_FILES: '4'
          MAX_DESCRIPTION_CHARS: '20000'
          MAX_ATTACHMENT_CHARS: '16000'
          MODEL_ID_DESC: 'amazon.nova-pro-v1:0'
          MODEL_ID_MATCH: 'amazon.nova-pro-v1:0'
          MAX_TOKENS: '8000'
          TEMPERATURE: '0.1'
          DEBUG_MODE: 'true'
          PROCESS_DELAY_SECONDS: '60'
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-sqs-generate-match-reports'

  SamProduceUserReportFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-produce-user-report-${Environment}'
        - !Sub 'sam-produce-user-report-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamProduceUserReportRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 1024
      Timeout: 180  # 3 minutes
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          OUTPUT_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-opportunity-responses-${Environment}'
            - !Sub 'sam-opportunity-responses-${Environment}'
          SAM_OPPORTUNITY_RESPONSES_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-opportunity-responses-${Environment}'
            - !Sub 'sam-opportunity-responses-${Environment}'
          SAM_MATCHING_OUT_SQS_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-matching-out-sqs-${Environment}'
            - !Sub 'sam-matching-out-sqs-${Environment}'
          AGENT_ID: 'PLACEHOLDER'
          AGENT_ALIAS_ID: 'PLACEHOLDER'
          OUTPUT_FORMATS: 'txt,docx'
          COMPANY_NAME: !Ref CompanyName
          COMPANY_CONTACT: !Ref CompanyContact
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-produce-user-report'

  SamMergeAndArchiveResultLogsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-merge-and-archive-result-logs-${Environment}'
        - !Sub 'sam-merge-and-archive-result-logs-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamMergeAndArchiveResultLogsRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 128
      Timeout: 300  # 5 minutes
      EphemeralStorage:
        Size: 512
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          S3_OUT_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-matching-out-runs-${Environment}'
            - !Sub 'sam-matching-out-runs-${Environment}'
          active: 'true'
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-merge-and-archive-result-logs'

  SamProduceWebReportsFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-produce-web-reports-${Environment}'
        - !Sub 'sam-produce-web-reports-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamProduceWebReportsRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 1024
      Timeout: 300  # 5 minutes
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          BUCKET_PREFIX: !Ref BucketPrefix
          ENVIRONMENT: !Ref Environment
          WEBSITE_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-website-${Environment}'
            - !Sub 'sam-website-${Environment}'
          SAM_WEBSITE_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-website-${Environment}'
            - !Sub 'sam-website-${Environment}'
          SAM_MATCHING_OUT_RUNS_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-matching-out-runs-${Environment}'
            - !Sub 'sam-matching-out-runs-${Environment}'
          DASHBOARD_PATH: 'dashboards/'
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-produce-web-reports'

  SamDailyEmailNotificationFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !If 
        - HasBucketPrefix
        - !Sub '${BucketPrefix}-sam-daily-email-notification-${Environment}'
        - !Sub 'sam-daily-email-notification-${Environment}'
      Runtime: python3.11
      Handler: lambda_function.lambda_handler
      Role: !GetAtt SamDailyEmailNotificationRole.Arn
      Code:
        ZipFile: |
          def lambda_handler(event, context):
              return {'statusCode': 200, 'body': 'Function placeholder'}
      MemorySize: 512
      Timeout: 300  # 5 minutes
      TracingConfig:
        Mode: Active
      Environment:
        Variables:
          EMAIL_ENABLED: 'true'
          SES_REGION: 'us-east-1'
          FROM_EMAIL: 'mga.aws2024@gmail.com'
          EMAIL_SUBJECT_TEMPLATE: 'Daily AWS AI-Powered RFI/RFP Response for {date}'
          EMAIL_BODY_TEMPLATE: 'Dear {name}, here is the Daily Website for your review.\n\nI have attached a zip file containing only the high scoring opportunity matches for {date}.\n\nPlease review the Daily Opportunities Website at the URL below for a summary of all data that was processed.'
          OPPORTUNITY_RESPONSES_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-opportunity-responses-${Environment}'
            - !Sub 'sam-opportunity-responses-${Environment}'
          WEBSITE_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-website-${Environment}'
            - !Sub 'sam-website-${Environment}'
          WEBSITE_BASE_URL: !If 
            - HasBucketPrefix
            - !Sub 'http://${BucketPrefix}-sam-website-${Environment}.s3-website-us-east-1.amazonaws.com'
            - !Sub 'http://sam-website-${Environment}.s3-website-us-east-1.amazonaws.com'
          SUBSCRIBERS_BUCKET: !If 
            - HasBucketPrefix
            - !Sub '${BucketPrefix}-sam-subscribers'
            - !Sub 'sam-subscribers'
          SUBSCRIBERS_FILE: 'subscribers_daily.csv'
          X_AMZN_TRACE_ID: !Sub '${AWS::StackName}-sam-daily-email-notification'

  # Event Source Mappings
  SqsEventSourceMapping:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !Ref SqsSamJsonMessagesQueueArn
      FunctionName: !Ref SamSqsGenerateMatchReportsFunction
      BatchSize: 1
      MaximumBatchingWindowInSeconds: 0
      FunctionResponseTypes:
        - ReportBatchItemFailures

Outputs:
  SamGovDailyDownloadFunctionArn:
    Description: 'ARN of the SAM.gov daily download Lambda function'
    Value: !GetAtt SamGovDailyDownloadFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SamGovDailyDownloadFunction'
  
  SamJsonProcessorFunctionArn:
    Description: 'ARN of the JSON processor Lambda function'
    Value: !GetAtt SamJsonProcessorFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SamJsonProcessorFunction'
  
  SamMergeAndArchiveResultLogsFunctionArn:
    Description: 'ARN of the merge and archive Lambda function'
    Value: !GetAtt SamMergeAndArchiveResultLogsFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SamMergeAndArchiveResultLogsFunction'
  
  SamDailyEmailNotificationFunctionArn:
    Description: 'ARN of the daily email notification Lambda function'
    Value: !GetAtt SamDailyEmailNotificationFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SamDailyEmailNotificationFunction'